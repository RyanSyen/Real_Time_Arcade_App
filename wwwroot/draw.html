<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=520, initial-scale=1.0" />
    <title>DrawRT 1.0</title>
    <link href="images/favicon.png" rel="shortcut icon" />
    <link href="css/app.css" rel="stylesheet" />
    <style>
      #box {
        border: 1px solid #999;
        width: 35px;
        height: 35px;
        /* TODO */
        /*to center the dot in the square box*/
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #pen {
        background: #000;
        border: 1px solid #000;
        border-radius: 50%;
        width: 5px;
        height: 5px;
      }

      #panel {
        width: 500px;
        margin-bottom: 10px;
        /* TODO */
        /*to allign all the tools in one line*/
        display: flex;
        /*when display is flex, the default value for align-items is center*/
      }

      #size {
        /* TODO */
        /*this is a flex child*/
        flex: 1 1 auto;
        /*
            1: allow to grow
            1: allow to shrink
            auto: default width and height
            */
      }

      #color {
        /* TODO */
        width: 60px;
        height: auto;
      }

      #canvas {
        display: block;
        border: 1px solid #999;
        /* TODO */
        cursor: url(images/pencil-down.png) 0 32, pointer; /*if url is not working, then will use the default pointer*/
        touch-action: none; /*dont want to have default action like scrolling, pinch, zoom in mobile touchscreen*/
        user-select: none;
      }
    </style>
  </head>

  <body>
    <header>
      <h1><a href="/">DrawRT 1.0</a></h1>
    </header>

    <main hidden>
      <div id="panel">
        <div id="box">
          <div id="pen"></div>
        </div>

        <input
          type="range"
          id="size"
          min="1"
          max="30"
          step="1"
          value="5"
          list="ticks"
        />
        <datalist id="ticks">
          <option value="5"></option>
          <option value="10"></option>
          <option value="15"></option>
          <option value="20"></option>
          <option value="25"></option>
          <option value="30"></option>
        </datalist>

        <input type="color" id="color" list="colors" />
        <datalist id="colors">
          <option value="#ff0000"></option>
          <option value="#ffa500"></option>
          <option value="#ffff00"></option>
          <option value="#008000"></option>
          <option value="#0000ff"></option>
          <option value="#4b0082"></option>
          <option value="#ee82ee"></option>
          <option value="#000000"></option>
          <option value="#ffffff"></option>
          <option value="#999999"></option>
          <option value="#00FF00"></option>
          <option value="#00FFFF"></option>
          <option value="#008080"></option>
          <option value="#CD5C5C"></option>
          <option value="#F08080"></option>
        </datalist>

        <button id="clear">üóëÔ∏è</button>

        <button id="image">üñºÔ∏è</button>
        <input type="file" id="file" accept="image/*" hidden />

        <button id="download">üíæ</button>
      </div>

      <canvas id="canvas" width="500" height="500"></canvas>
    </main>

    <script src="js/jquery.slim.js"></script>
    <script src="js/signalr.js"></script>
    <script src="js/app.js"></script>
    <script>
      // (1) Interactive UI Events ==============================================================
      $("#size").on("input", (e) => {
        //set the size
        let size = $("#size").val();
        //set the pen according to the size
        $("#pen").width(size).height(size); //change the width and height based on the size
      });

      $("#color").on("input", (e) => {
        let color = $("#color").val(); //#ff0000 return value
        $("#pen").css("background", color);
      });

      $("#size, #color").trigger("input"); //trigger input event so that the default values like red and pen size will be reflected

      $("#canvas").on("wheel", (e) => {
        e.preventDefault();
        let dy = e.originalEvent.deltaY;
        if (dy < 0) {
          //up
          $("#size")[0].stepUp();
        } else {
          //down
          $("#size")[0].stepDown();
        }
        $("#size").trigger("input");
      });

      //funciton to handle keyboard events
      $(document).keydown((e) => {
        //console.log(e.key, e.keyCode, e.code); //result when typing a -> a 65 KeyA
        //console.log(e.key, e.originalEvent.repeat); //to key which key is being pressed and whether its repeated or not so its either true or false
        if (e.originalEvent.repeat) return; // this will prevent the following code from running

        switch (e.key) {
          case " ":
            $("#clear").click();
            break;
          case "0":
            $("#color").val("#999999");
            break;
          case "1":
            $("#color").val("#ff0000");
            break;
          case "2":
            $("#color").val("#ffa500");
            break;
          case "3":
            $("#color").val("#ffff00");
            break;
          case "4":
            $("#color").val("#008000");
            break;
          case "5":
            $("#color").val("#0000ff");
            break;
          case "6":
            $("#color").val("#4b0082");
            break;
          case "7":
            $("#color").val("#ee82ee");
            break;
          case "8":
            $("#color").val("#000000");
            break;
          case "9":
            $("#color").val("#ffffff");
            break;
        }
        $("#color").trigger("input");
      });

      // (2) General Functions ==================================================================
      const can = $("#canvas")[0]; //browser object [0]
      const ctx = can.getContext("2d");

      ctx.lineCap = "round";
      ctx.lineJoin = "round";
      ctx.shadowBlur = 1;
      clear();

      function drawLine(a, b, size, color) {
        //from size a to b
        ctx.beginPath();
        ctx.moveTo(a.x, a.y); //starting point
        ctx.lineTo(b.x, b.y); //end point
        ctx.lineWidth = size;
        ctx.strokeStyle = color;
        ctx.shadowColor = color;
        ctx.stroke();
      }

      function drawCurve(a, b, c, size, color) {
        ctx.beginPath();
        ctx.moveTo(a.x, a.y);
        ctx.quadraticCurveTo(b.x, b.y, c.x, c.y);
        ctx.lineWidth = size;
        ctx.strokeStyle = color;
        ctx.shadowColor = color;
        ctx.stroke();
      }

      function clear() {
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, can.width, can.height);
      }

      //drawImage
      //we want to convert this function into promise or awaitable function
      //because it takes time to load
      function drawImage(url) {
        
        // let img = new Image();
        // img.onload = (e) => {
        //   ctx.drawImage(img, 0, 0);
        // };
        // img.src = url;
        return new Promise(resolve => {
                let img = new Image();
                img.onload = e => {
                    ctx.drawImage(img, 0, 0);
                    resolve();
                };
                img.src = url;
            });
      }

      //calculate mid point for curve
      function mid(a, b) {
        return { x: (a.x + b.x) / 2, y: (a.y + b.y) / 2 };
      }

      // TODO: Awaitable sleep function
      function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

      // (3) Draw Events ========================================================================

      //$("#canvas").on("pointerdown", (e) => {
      //console.log(e.offsetX, e.offsetY, e.buttons, e.originalEvent.isPrimary);
      //is primary is your finger first touch for mobile

      //to draw a cruve we need to have a array to hold 3 points
      //let a = null; -> need to change to array
      let arr = [];

      $("#canvas").on("pointerdown", (e) => {
        if (e.buttons == 1 && e.originalEvent.isPrimary) {
          a = { x: e.offsetX, y: e.offsetY };
        }
      });

      $("#canvas").on("pointermove pointerout", (e) => {
        if (e.buttons == 1 && e.originalEvent.isPrimary) {
          let size = $("#size").val() * 1;
          let color = $("#color").val();

          // 1. Add start point (if needed)
          if (arr.length == 0) {
            arr.push({
              x: e.offsetX - e.originalEvent.movementX,
              y: e.offsetY - e.originalEvent.movementY,
            });
          }

          // 2. Add new point
          arr.push({ x: e.offsetX, y: e.offsetY });
          arr = arr.slice(-3); // Keep last 3 points only

          if (arr.length >= 3) {
            // arr = [0, 1, 2]
            let a = mid(arr[0], arr[1]);
            let b = arr[1];
            let c = mid(arr[1], arr[2]);
            drawCurve(a, b, c, size, color);
            //call hub method to send the command to other recipent
            con.invoke("SendCurve", a, b, c, size, color);
          } else {
            // arr = [0, 1]
            let a = arr[0];
            let b = mid(arr[0], arr[1]);
            drawLine(a, b, size, color);
            //call hub method to send the command to other recipent
            con.invoke("SendLine", a, b, size, color);
          }
        }
      });

      $("#canvas").on("pointerup pointerout", (e) => {
        //a = null;
        if (arr.length >= 2) {
          arr = arr.slice(-2); // keep last 2 lines only
          let size = $("#size").val() * 1;
          let color = $("#color").val();
          let a = mid(arr[0], arr[1]);
          let b = arr[1];
          drawLine(a, b, size, color);
          //call hub method to send the command to other recipent
          con.invoke("SendLine", a, b, size, color);
        }
        arr = [];
      });

      $("#clear").click((e) => {
        clear();
        //call hub method to send the command to other recipent
        con.invoke("SendClear");
      });

      //handle file button
      $("#image").click((e) => $("#file").click());

      $("#file").change((e) => {
        let f = e.target.files[0];

        if (f && f.type.startsWith("image/")) {
          crop(f, can.width, can.height, "dataURL", "image/jpeg").then(
            (url) => {
              drawImage(url);
              //Log image size -> show image size
              console.log(url.length);
              //call hub method to send the command to other recipent
              con.invoke("SendImage", url);
            }
          );
        }
        e.target.value = null;
      });

      //download feature
      $("#download").click((e) => {
        let a = $("<a>")[0];
        a.href = can.toDataURL("image/png");
        a.download = Date.now() + ".png";
        a.click();
      });

      // (4) SignalR ============================================================================

      const con = new signalR.HubConnectionBuilder().withUrl("/drawhub").build();

      con.on("ReceiveLine", drawLine);
      con.on("ReceiveCurve", drawCurve);
      con.on("ReceiveImage", drawImage);
      con.on("ReceiveClear", clear);

      con.on("ReceiveCommands", async (commands) => {
        for (let cmd of commands) {
          await window[cmd.name](...cmd.param);
           await sleep(1);
        }
      });

      con.onclose((err) => {
        alert("Disconnected");
        location = "/draw.html";
      });

      con.start().then(() => $("main").show()); // if connection to hub is successful then you will see the 'main' element. Else it will be hidden
    </script>
  </body>
</html>
