<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Chat Room</title>
    <link href="image/favicon.png" rel="shortcut icon">
    <link href="css/app.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"
        integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
    <link rel="stylesheet" href="css/global.css">
    <style>
        body {  
            width: 70%;
            margin: auto;
            display: flex;
            flex-direction: row;
            flex: 1 1;
        }

        .box1 {
            flex: 20%;
            background-color: #C0C0C0;
            /* padding: 20px; */
            border: 1px solid black;
        }

        .box2 {
            display: flex;
            flex-direction: column;
            flex: 80%;
            border: 1px solid black;
        }

        .image {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #999;
            cursor: pointer;
        }

        .image:fullscreen {
            object-fit: scale-down;
        }

        .active {
            outline: 5px dashed red;
            outline-offset: -5px;
        }

        .profile-photo {
            border-radius: 50%;
            width: 60px;
            height: 60px;
            object-fit: cover;
        }

        .profile-name {
            font-size: 1.2rem;
            padding-right: 0.4em;
        }
    </style>
</head>
<body>
    <div class="box1">
        <p>Online User List</p>     
    </div>
    <div class="box2">
        <header>
            <h1>Chat</h1>
            <!-- <div>üë§ = <b id="count">0</b></div> -->
        </header>

        <main>
            <ul id="chat"></ul>         
        </main>

        <footer>
            <form id="form" autocomplete="off">
                <input type="text" id="message" placeholder="Enter Message" autofocus>
                <button type="button" id="image">Image</button>
                <button type="button" id="leave">Leave</button>
                <input type="file" id="file" accept="image/*" hidden>
            </form>
        </footer>
    </div>
    <!-- JavaScript Section -->
    <script src="js/jquery.slim.js"></script>
    <script src="js/signalr.js"></script>
    <script src="js/app.js"></script>
    <script>
        const name = sessionStorage.getItem('name');

        $('#list')

        if (!name) {
            location = '/';
            throw 'ERROR: Invalid name';
        }

        $('#leave').click(e => {
            sessionStorage.clear();
            location = '/';
        });

        const m = $('main')[0];
        let bottom = true;

        function isBottom() {
            bottom = m.scrollTop + m.clientHeight + 10 >= m.scrollHeight;
        }

        function scrollToBottom() {
            if (bottom) {
                m.scrollTop = m.scrollHeight;
            }
        }

        function getImageURL(message) {
            let re = /.(jpg|jpeg|png|webp|gif|bmp)$/i;
            try {
                let url = new URL(message);
                if (re.test(url.pathname)) {
                    return url.href;
                }
            }
            catch {

            }
            return null;
        }

        function getYouTubeId(message) {
            try {
                let url = new URL(message);
                if (url.hostname == 'www.youtube.com' && url.pathname == '/watch') {
                    return url.searchParams.get('v');
                }
            }
            catch {

            }
            return null
        }

        const param = $.param({ name });
        
        const con = new signalR.HubConnectionBuilder()
            .withUrl('/hub?' + param)
            .build();

        con.on('ReceiveText', (name, message, who, time) => {
            //bad word filter (12 words)
            let badwords = /fuck|shit|piss|dick|ass|asshole|bitch|bastard|damn|bollocks|bugger|rubbish/gi;

            message = message
                .replaceAll('`smile`', 'üòä')
                .replaceAll('`cry`', 'üò•')
                .replaceAll('`heart`', '‚ù§Ô∏è')
                .replaceAll('`thank`', 'üôè')
                .replaceAll('`strong`', 'üí™')
                .replaceAll('`lovely`', 'ü•∞')
                .replaceAll('`fire`', 'üî•')
                .replaceAll('`laughing`', 'ü§£')
                .replaceAll('`pleading`', 'ü•∫')
                .replaceAll('`sparkle`', '‚ú®')
                .replaceAll('`joy`', 'üòÇ')
                .replaceAll('`crying`', 'üò≠')
                .replace(/\*(.*?)\*/g, "<b>$1</b>")
                .replace(/_(.*?)_/g, "<u>$1</u>")
                .replace(/~(.*?)~/g, "<i>$1</i>")
                .replace(/-(.*?)-/g, "<del>$1</del>")
                .replace(badwords, "****");
                
            message = message.replace(
                /(?<=^|\s)(https?:\/\/\S+)(?=$|\s)/gi,
                '<a href="$&" target="_blank">$&</a>'
            );

            let today = new Date();
            let minutes = today.getMinutes();
            minutes = minutes <= 9 ? '0' + minutes : minutes;
            time = today.getDate() + "-" + (today.getMonth()+1) + "-" + today.getFullYear() + " [" + (today.getHours()%12) + ":" + minutes + "]";

            isBottom();
            if(who == 'caller') {
                $('#chat').append(`
                    <li class="${who}">
                        <div>
                            <b>${name}:</b> ${message} <small style="color: grey;">${time} <i class="fas fa-check-double"></i></small>
                        </div>
                    </li>
                `);
            }
            else {
                $('#chat').append(`
                <li class="${who}">
                    <div>
                        <b>${name}:</b> ${message} <small style="color: grey;">${time} <i class="fas fa-check-double" style="color: black;"></i></small>
                    </div>
                </li>
            `);
            }
            scrollToBottom();
        });

        con.on('UpdateStatus', (count, status) => {
            $('#count').text(count);

            isBottom();
            $('#chat').append(`
                <li class="status">
                    <div>${status}</div>
                </li>
            `);
            scrollToBottom();
        });

        con.on('ReceiveImage', (name, url, who) => {
            let today = new Date();
            let minutes = today.getMinutes();
            minutes = minutes <= 9 ? '0' + minutes : minutes;
            time = today.getDate() + "-" + (today.getMonth()+1) + "-" + today.getFullYear() + " [" + (today.getHours()%12) + ":" + minutes + "]";

            isBottom();
            if(who == 'caller') {
                $('#chat').append(`
                    <li class="${who}">
                        <div>
                            <b>${name}</b> sent an image<br>
                            <img src="${url}" class="image"
                                onload="scrollToBottom()"><br>
                            <small style="color: grey;">${time} <i class="fas fa-check-double"></i></small>
                        </div>
                    </li>
                `);
            }
            else {
                $('#chat').append(`
                    <li class="${who}">
                        <div>
                            <b>${name}</b> sent an image<br>
                            <img src="${url}" class="image"
                                onload="scrollToBottom()"><br>
                            <small style="color: grey;">${time} <i class="fas fa-check-double" style="color: black;"></i></small>
                        </div>
                    </li>
                `);
            }
        });

        con.on('ReceiveYouTube', (name, id, who) => {
            let today = new Date();
            let minutes = today.getMinutes();
            minutes = minutes <= 9 ? '0' + minutes : minutes;
            time = today.getDate() + "-" + (today.getMonth()+1) + "-" + today.getFullYear() + " [" + (today.getHours()%12) + ":" + minutes + "]";

            isBottom();
            if(who == 'caller') {
                $('#chat').append(`
                    <li class="${who}">
                        <div>
                            <b>${name}</b> sent a video<br>
                            <iframe width="400" height="300" 
                                    src="https://www.youtube.com/embed/${id}" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen></iframe><br>
                                    <small style="color: grey;">${time} <i class="fas fa-check-double"></i></small>
                        </div>
                    </li>
                `);
            }
            else {
                $('#chat').append(`
                    <li class="${who}">
                        <div>
                            <b>${name}</b> sent a video<br>
                            <iframe width="400" height="300" 
                                    src="https://www.youtube.com/embed/${id}" 
                                    frameborder="0" 
                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen></iframe><br>
                                    <small style="color: grey;">${time} <i class="fas fa-check-double" style="color: black;"></i></small>
                        </div>
                    </li>
                `);
            }
            scrollToBottom();
        });

        con.onclose(err => {
            sessionStorage.clear();
            location = '/';
        });

        con.start().then(main);

        function main() {
            
            $('#form').submit(e => {
                e.preventDefault();
                let message = $('#message').val().trim();
                if (message) {
                    let url = getImageURL(message);
                    let id  = getYouTubeId(message);

                    if (url) {
                        con.invoke('SendImage', name, url);
                    }
                    else if (id) {
                        con.invoke('SendYouTube', name, id);
                    }
                    else {
                        con.invoke('SendText', name, message);
                    }
                }
                $('#message').val('').focus();
            });

            $('#chat').on('click', '.image', e => e.target.requestFullscreen());

            $('#image').click(e => $('#file').click());

            $('#file').change(e => {
                let f = e.target.files[0];

                if (f && f.type.startsWith('image/')) { 
                    // let fr = new FileReader();
                    // fr.onload = e => {
                    //     let url = e.target.result;
                    //     con.invoke('SendImage', name, url);
                    // };
                    // fr.readAsDataURL(f);

                    fit(f, 500, 500, 'dataURL', 'image/webp')
                        .then(url => con.invoke('SendImage', name, url));
                }

                e.target.value = null;
            });

            $('main').on('dragenter dragover', e => {
                e.preventDefault();
                $('main').addClass('active');
            });

            $('main').on('dragleave drop', e => {
                e.preventDefault();
                $('main').removeClass('active');
            });

            $('main').on('drop', e => {
                e.preventDefault();
                let f = e.originalEvent.dataTransfer.files[0];

                if (f && f.type.startsWith('image/')) { 
                    fit(f, 500, 500, 'dataURL', 'image/webp')
                        .then(url => con.invoke('SendImage', name, url));
                }
            });

            $('#name, #header-name').text(sessionStorage.getItem('name'));
            $('#photo, #header-avatar').prop('src', sessionStorage.getItem('photo'));
        }
    </script>
</body>
</html>