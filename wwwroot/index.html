<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG</title>
    <link href="image/favicon.png" rel="shortcut icon">
    <link href="css/app.css" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"
        integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
    <link rel="stylesheet" href="css/global.css">
    <script type="text/javascript" src="https://unpkg.com/webcam-easy/dist/webcam-easy.min.js"></script>
    <style>
        html,
        body {
            height: 100%;
            width: 100%;
        }

        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 100%;
        }

        .container {
            width: 40%;
            padding: 0 1em 0.5em;
            border: 2px solid black;
        }

        .avatar-selection>label {
            position: relative;
        }

        .avatar {
            border-radius: 50%;
            max-width: 80px;
            cursor: pointer;
        }

        .checkmark {
            position: absolute;
            right: 0;
            font-size: 1.4rem;
            color: blue;
            background-color: white;
            border-radius: 50%;
            display: none;
            border: 2px solid white;
        }

        .avatar-selection {
            display: grid;
            grid-template-columns: 90px 90px 90px 90px;
            grid-template-rows: 90px 90px;
            border-bottom: 1px solid grey;
            border-top: 1px solid grey;
            padding: 1em 0;
            align-content: center;
            align-items: center;
            justify-content: center;
            grid-gap: 0.5em;
        }

        .avatar-selection>label>input:checked~.checkmark {
            display: inline-block;
        }

        .avatar-selection>label>input:checked~.avatar {
            border: 5px solid green;
        }

        .upload {
            position: relative;
        }

        .photo {
            border-radius: 50%;
            width: 100px;
            height: 100px;
            display: block;
            margin: 1em auto;
            transition: 0.2s ease;
            object-fit: cover;
        }

        .fa-image {
            display: none;
            font-size: 2rem;
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: -1;
        }

        .upload:hover .fa-image {
            display: inline-block;
        }

        photo:hover {
            cursor: pointer;
            opacity: 0.3;
        }

        #nameError {
            color: #ff4040;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        #name {
            width: 100%;
            display: block;
            box-sizing: border-box;
            font-size: 1rem;
            padding: 0.3em 0.5em;
            background-color: #e3e3e3;
            border: none;
            margin-top: 1em;
        }

        #name:focus {
            background-color: white;
        }

        #name:focus::placeholder {
            color: transparent;
        }

        #join {
            width: 100%;
            display: block;
            padding: 0.7em;
            font-size: 1rem;
            border-radius: 10px;
            border: none;
            background-color: #1d5dc2;
            cursor: pointer;
            font-weight: bold;
            margin-top: 1em;
            color: white;
        }

        #join:hover {
            background-color: #124494;
        }

        @media (max-width: 1100px) {
            .container {
                width: 60%;
            }

            .photo {
                width: 90px;
                height: 90px;
            }

            .avatar {
                max-width: 60px;
            }
        }

        @media (max-width:1100px) {
            .container {
                width: 95%;
            }

            .photo {
                width: 80px;
                height: 80px;
            }

            .avatar-selection {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }

            #nameError {
                font-size: 0.9rem;
            }

            .avatar-selection>label>input:checked~.avatar {
                border: 2px solid green;
            }

            .checkmark {
                font-size: 1.1rem;
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            padding-top: 100px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }

        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        canvas {
            display: none;
            object-fit: cover;
        }

        #snap a {
            text-decoration: none;
            color: black;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="./image/favicon.png">
        <h1>Real-time Arcade Game</h1>
        
        <form class="avatar-selection" autocomplete="off">
            <label>
                <input type="radio" name="avatar" value="./image/Avatar1.png" hidden>
                <img class="avatar" src="./image/Avatar1.png">
                <i class="checkmark fas fa-check-circle"></i>
            </label>
            <label>
                <input type="radio" name="avatar" value="./image/Avatar2.png" hidden>
                <img class="avatar" src="./image/Avatar2.png">
                <i class="checkmark fas fa-check-circle"></i>
            </label>
            <label>
                <input type="radio" name="avatar" value="./image/Avatar3.png" hidden>
                <img class="avatar" src="./image/Avatar3.png">
                <i class="checkmark fas fa-check-circle"></i>
            </label>
            <label>
                <input type="radio" name="avatar" value="./image/Avatar4.png" hidden>
                <img class="avatar" src="./image/Avatar4.png">
                <i class="checkmark fas fa-check-circle"></i>
            </label>
            <label>
                <input type="radio" name="avatar" value="./image/Avatar5.png" hidden>
                <img class="avatar" src="./image/Avatar5.png">
                <i class="checkmark fas fa-check-circle"></i>
            </label>
            <label>
                <input type="radio" name="avatar" value="./image/Avatar6.png" hidden>
                <img class="avatar" src="./image/Avatar6.png">
                <i class="checkmark fas fa-check-circle"></i>
            </label>
            <label>
                <input type="radio" name="avatar" value="./image/Avatar7.png" hidden>
                <img class="avatar" src="./image/Avatar7.png">
                <i class="checkmark fas fa-check-circle"></i>
            </label>
            <label>
                <input type="radio" name="avatar" value="./image/Avatar8.png" hidden>
                <img class="avatar" src="./image/Avatar8.png">
                <i class="checkmark fas fa-check-circle"></i>
            </label>
        </form>

        <div class="upload">
            <img id="photo" class="photo" src="./image/AddProfile.png">
            <input type="file" id="file" accept="image/*" hidden>
            <i class="fas fa-image"></i>

            <button id="myBtn">Webcam</button>

            <div id="myModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <p>
                        <button id="btntoggle" class="camera" onclick="cameraonoff()" style="position: absolute; top: 13.5%; right: 50%;">On Webcam</button>
                        <video id="video" style="width: 55%; height: 25%;" autoplay></video>
                        <button id="snap" style="position: absolute; top: 13.5%; left: 50%;"><a download="avatar" onclick="takeAPicture()">Snap</a></button>
                        <canvas id="canvas"></canvas>                       
                    </p>              
                </div>
            </div>

            <form autocomplete="off">
                <input type="text" id="name" placeholder="Username" maxlength="20" autofocus>
                <button id="join">Join</button>
            </form>
        </div>

    <!-- JavaScript Section -->
    <script src="js/jquery.slim.js"></script>
    <script>
        // Login
        let name = null;
        let photoSrc = null;

        $('#join').on('click', e => {
            e.preventDefault();

            name = $('#name').val();
            /* username = name; */
            photoSrc = $('#photo')[0].src;

            // if name does not exist
            if (!name) {
                alert("Username is required!");
                return;
            }

            // login and redirect to main.html
            sessionStorage.setItem('name', name);
            sessionStorage.setItem('photo', photoSrc);

            window.location = 'main.html';
        });

        // Display Chosen Avatar
        let imageSrc = null;
        $('input[type=radio][name=avatar]').on('change', e => {
        e.preventDefault();

        imageSrc = $(e.currentTarget).next()[0].src;
        $('#photo').prop('src', imageSrc);
        });

        // Select Photo
        $('.photo').click(e => $('#file').click());
        $('.upload input').change(e => {
            let f = e.target.files[0];
            let img = $(e.target).siblings('img')[0];

            if (f && f.type.startsWith('image/')) {
                img.src = URL.createObjectURL(f);
            }
            e.target.value = null;
        });

    // Open Modal
    var modal = document.getElementById("myModal");

    var btn = document.getElementById("myBtn");

    var span = document.getElementsByClassName("close")[0];

    btn.onclick = function() {
    modal.style.display = "block";
    }

    span.onclick = function() {
        modal.style.display = "none";
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // On/Off Webcam
    var videoElem = document.getElementById("video");
    var btnElm = document.getElementById("btntoggle");
    var isPlaying = !!videoElem.srcObject;

    function cameraonoff() {
        if (!isPlaying) {
            cameraon();
        } else {
            cameraoff();
        }
    }

    function cameraon() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices
            .getUserMedia({
              video: true
            })
            .then(function (stream) {
              videoElem.srcObject = stream;
              videoElem.play();
            })
            .then(() => {
              isPlaying = true;
              btnElm.innerText = "Off Webcam";
            });
        }    
        // Call takeAPicture() Function
        takeAPicture();
    }

    function cameraoff() {
        const stream = videoElem.srcObject;
        if (stream) {
          const tracks = stream.getTracks();

          tracks.forEach(function (track) {
            track.stop();
          });

          videoElem.srcObject = null;
          isPlaying = false;
          btnElm.innerText = "On Webcam";
        }
    }

    // Snap
    const canvasElement = document.getElementById("canvas");
    const webcam = new Webcam(videoElem, "user", canvasElement);

    function takeAPicture() {
        let picture = webcam.snap();
        document.querySelector("a").href = picture;
    }
    </script>

</body>
</html>